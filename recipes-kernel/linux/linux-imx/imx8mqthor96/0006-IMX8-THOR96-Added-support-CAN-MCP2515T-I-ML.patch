From ee2d7aa6c41dbc19fd668d269af84efa59ba482b Mon Sep 17 00:00:00 2001
From: Tejas Patel <tejas.patel1@einfochips.com>
Date: Tue, 19 Oct 2021 14:34:56 +0530
Subject: [PATCH 06/16] IMX8 THOR96: Added support CAN MCP2515T-I/ML

Commands for testing:
$ ip link set can0 type can bitrate 125000;ifconfig can0 up

Configure one board as receiver
$ candump can0 &

Configure another board as sender and send data
$ cansend can0 18FC2A00#0100000000000000

Change-Id: I8f810e20c5a2f22ceef9f43d7b080d347ad425dd
Signed-off-by: Tejas Patel <tejas.patel1@einfochips.com>
Signed-off-by: Tanvi Chauhan <tanvi.chauhan@einfochips.com>

diff --git a/arch/arm64/boot/dts/freescale/imx8mq-thor96.dts b/arch/arm64/boot/dts/freescale/imx8mq-thor96.dts
index 8f3b9e2f9..f87030a9c 100644
--- a/arch/arm64/boot/dts/freescale/imx8mq-thor96.dts
+++ b/arch/arm64/boot/dts/freescale/imx8mq-thor96.dts
@@ -16,6 +16,14 @@
 		stdout-path = &uart1;
 	};
 
+	clocks {
+		clk24M: can_clock {
+			compatible = "fixed-clock";
+			#clock-cells = <0>;
+			clock-frequency = <20000000>;
+		};
+	};
+
 	memory@40000000 {
 		device_type = "memory";
 		reg = <0x00000000 0x40000000 0 0x80000000>;
@@ -67,6 +75,15 @@
 		};
 	};
 
+
+	can_reset: can-reset {
+		compatible = "gpio-reset";
+		reset-gpios = <&gpio3 25 GPIO_ACTIVE_LOW>;
+		reset-delay-us = <2000>;
+		reset-post-delay-ms = <40>;
+		#reset-cells = <0>;
+	};
+
 	reg_usdhc1_vmmc: reg-usdhc1-vmmc {
 		compatible = "regulator-fixed";
 		regulator-name = "VDD_3V3";
@@ -352,6 +369,26 @@
 	status = "okay";
 };
 
+&ecspi1 {
+		pinctrl-names = "default";
+		pinctrl-0 = <&pinctrl_ecspi1>;
+		fsl,spi-num-chipselects = <1>;
+		cs-gpios = <&gpio1 1 GPIO_ACTIVE_LOW>;
+		spi-max-frequency = <10000000>;
+		status = "okay";
+
+	can0: can@0 {
+		pinctrl-names = "default";
+		compatible = "microchip,mcp2515";
+		reg = <0>;
+		spi-max-frequency = <1000000>;
+		clocks = <&clk24M>;
+		interrupt-parent = <&gpio1>;
+		interrupts = <6 0x02>;
+		status = "okay";
+	};
+};
+
 /* SDIO */
 &usdhc1 {
 	#address-cells = <0x1>;
@@ -400,6 +437,18 @@
 };
 
 &iomuxc {
+        pinctrl_ecspi1: ecspi1grp { /*can spi interface*/
+                fsl,pins = <
+                        MX8MQ_IOMUXC_ECSPI1_SCLK_ECSPI1_SCLK    0x16
+                        MX8MQ_IOMUXC_ECSPI1_MOSI_ECSPI1_MOSI    0x16
+                        MX8MQ_IOMUXC_ECSPI1_MISO_ECSPI1_MISO    0x16
+                        MX8MQ_IOMUXC_GPIO1_IO01_GPIO1_IO1               0x16
+                        MX8MQ_IOMUXC_SAI5_MCLK_GPIO3_IO25               0x19 /*reset*/
+                        MX8MQ_IOMUXC_GPIO1_IO06_GPIO1_IO6               0x19
+
+                >;
+        };
+
 	pinctrl_bt_gpios: btgpiosgrp {
 		fsl,pins = <
 			MX8MQ_IOMUXC_SAI5_RXD1_GPIO3_IO22		0x19
@@ -490,7 +539,6 @@
 			MX8MQ_IOMUXC_NAND_DATA01_QSPI_A_DATA1		0x82
 			MX8MQ_IOMUXC_NAND_DATA02_QSPI_A_DATA2		0x82
 			MX8MQ_IOMUXC_NAND_DATA03_QSPI_A_DATA3		0x82
-
 		>;
 	};
 
diff --git a/arch/arm64/configs/defconfig b/arch/arm64/configs/defconfig
index 396ac92bc..e4d5212c1 100644
--- a/arch/arm64/configs/defconfig
+++ b/arch/arm64/configs/defconfig
@@ -122,6 +122,10 @@ CONFIG_CRYPTO_AES_ARM64_CE_CCM=y
 CONFIG_CRYPTO_AES_ARM64_CE_BLK=y
 CONFIG_CRYPTO_CHACHA20_NEON=m
 CONFIG_CRYPTO_AES_ARM64_BS=m
+#
+# CAN SPI interfaces
+#
+CONFIG_CAN_MCP251X=y
 CONFIG_JUMP_LABEL=y
 CONFIG_MODULES=y
 CONFIG_MODULE_UNLOAD=y
@@ -187,6 +191,7 @@ CONFIG_BPF_JIT=y
 CONFIG_NET_PKTGEN=m
 CONFIG_CAN=m
 CONFIG_CAN_FLEXCAN=m
+CONFIG_CAN_MCP251X=y
 CONFIG_CAN_RCAR=m
 CONFIG_CAN_RCAR_CANFD=m
 CONFIG_BT=y
-- 
2.17.1

